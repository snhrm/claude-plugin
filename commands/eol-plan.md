---
description: フロントエンドライブラリのEOL対応計画を作成し、MDファイルに出力する
argument-hint: [指示内容] (省略可。フリーワードで要件を指定)
allowed-tools: Read, Write, Edit, Grep, Glob, Bash, WebFetch, WebSearch, Task
---

# EOL対応計画の作成

フロントエンドプロジェクトのライブラリEOL（End of Life）対応計画を作成し、Markdownファイルに出力します。

## 引数

- `$ARGUMENTS`: フリーワードで要件を指定できます
  - 省略時: プロジェクト全体の依存関係を対象に計画を作成

### 引数の指定パターン

```
/eol-plan react@19 next@15
/eol-plan Node.jsを22系までアップデートしライブラリを可能な範囲で最新化
/eol-plan recoilをjotaiに置き換え
/eol-plan セキュリティ脆弱性のあるパッケージのみ対応
```

---

## 実行フロー

このコマンドは以下のフローで実行します。**サブエージェントへの無駄な呼び出しを避けるため、情報収集はこのコマンド内で完結させます。**

```
[Step 1-4] 情報収集（このコマンドで実行）
    ↓
[Step 5] サブエージェント呼び出し（調査のみ依頼）
    ↓
[Step 6-7] 戦略決定・計画書作成（このコマンドで実行）
```

---

## Step 1: 初期情報の収集

以下の情報を一括で収集（並列実行可能）:

### 1.1 出力先の決定
```bash
# CLAUDE.mdから出力先を確認
grep -i "EOL計画出力先" CLAUDE.md
```
指定がない場合: プロジェクトルートに `eol-plan.md` を作成

### 1.2 パッケージマネージャーの特定
```bash
# ロックファイルの存在確認（優先順位: bun > pnpm > yarn > npm）
ls bun.lockb bun.lock pnpm-lock.yaml yarn.lock package-lock.json 2>/dev/null | head -1
```

### 1.3 プロジェクト構成の確認
```bash
# ソース/テストディレクトリの特定
ls -d src/ app/ pages/ components/ __tests__/ tests/ 2>/dev/null
```

### 1.4 Node.jsバージョンの確認
```bash
# バージョンファイルの確認
cat .nvmrc .node-version 2>/dev/null || grep '"node"' package.json
```

---

## Step 2: 依存関係の一括取得

### 2.1 npm-check-updates で最新バージョン確認
```bash
npx npm-check-updates --jsonUpgraded 2>/dev/null || npx npm-check-updates
```

### 2.2 セキュリティ監査
```bash
# パッケージマネージャーに応じて実行
npm audit --json 2>/dev/null || npm audit
yarn audit --json 2>/dev/null || yarn audit
pnpm audit --json 2>/dev/null || pnpm audit
```

### 2.3 package.json の読み込み
```bash
cat package.json
```

---

## Step 3: 引数の解析と対象決定

引数の内容を解析し、対象ライブラリを決定:

| パターン | 例 | 処理 |
|---------|-----|------|
| バージョン指定 | `react@19` | 指定バージョンへ更新 |
| ランタイム指定 | `Node.js 22系` | 互換ライブラリも含めて計画 |
| ライブラリ置換 | `recoilをjotaiに置き換え` | 移行計画を作成 |
| 範囲指定 | `可能な範囲で最新化` | 破壊的変更が少ないものから |
| 制約条件 | `React 18のまま` | 指定ライブラリは現状維持 |
| セキュリティ優先 | `脆弱性のみ` | audit結果から絞り込み |

引数がない場合の優先順位:
1. セキュリティ脆弱性があるパッケージ
2. EOLまたはサポート終了のパッケージ
3. メジャーバージョンアップが可能なパッケージ
4. マイナー/パッチアップデートがあるパッケージ

---

## Step 4: ライブラリグループの構成

依存関係が自明なライブラリをグループ化（サブエージェントへの呼び出し回数を削減）:

| グループ | メインライブラリ | 関連ライブラリ |
|---------|----------------|---------------|
| React コア | react | react-dom, @types/react, @types/react-dom |
| Next.js | next | react, react-dom, eslint-config-next |
| Vue コア | vue | @vue/compiler-sfc, vue-router, pinia |
| ESLint | eslint | eslint-config-*, eslint-plugin-* |
| TypeScript | typescript | @types/*, ts-node |

### グルーピング結果の作成

```
グループ1: Next.js
  - next: 14.0.4 → 15.0.0
  - react: 18.2.0 → 19.0.0
  - react-dom: 18.2.0 → 19.0.0
  - eslint-config-next: 14.0.4 → 15.0.0

グループ2: ESLint
  - eslint: 8.x → 9.x
  - eslint-plugin-react: x.x → y.y
  ...

単体: lodash 4.17.20 → 4.17.21
```

---

## Step 5: サブエージェント呼び出し（library-update-analyzer）

**各グループに対して1回ずつサブエージェントを呼び出す。**
収集済みの情報を渡し、調査のみを依頼する。

### 呼び出しフォーマット

```
調査対象:
  メインライブラリ: next
  現在バージョン: 14.0.4
  目標バージョン: 15.0.0
  関連ライブラリ: [react@18.2.0→19.0.0, react-dom@18.2.0→19.0.0, eslint-config-next@14.0.4→15.0.0]

プロジェクト情報:
  パッケージマネージャー: pnpm
  Node.jsバージョン: 20.10.0
  ソースディレクトリ: src/, app/
  テストディレクトリ: __tests__/, *.test.tsx
```

### サブエージェントからの戻り値（JSON）

```json
{
  "library": "next",
  "breakingChanges": [...],
  "deprecations": [...],
  "packagesToRemove": [...],
  "packagesToUpdate": [...],
  "testCoverage": {...},
  "summary": {
    "affectedFileCount": 5,
    "breakingChangeCount": 3,
    "estimatedEffort": "medium",
    "riskLevel": "medium"
  },
  "references": {...}
}
```

### 並列呼び出しの判断

- グループ間に依存関係がない場合: **並列で呼び出し可能**
- 依存関係がある場合（例: Next.js → React）: **順次呼び出し**

---

## Step 6: アップグレード戦略の決定

サブエージェントの結果を集約し、戦略を決定:

### 一括アップグレード（すべて満たす場合）
- 破壊的変更が合計3件以下
- 影響ファイルが合計10件以下
- 依存関係の競合がない

### 段階的アップグレード（1つでも該当する場合は必須）
- 🔴 破壊的変更が多い（4件以上）
- 🔴 影響ファイルが多い（11件以上）
- 🔴 複数のメジャーバージョンアップを含む
- 🔴 ライブラリの置換を含む
- 🔴 Node.jsのアップグレードを含む

### 段階的アップグレードの計画

1. **Phase 1: セキュリティ修正** - パッチバージョンのみ
2. **Phase 2: マイナーアップデート** - 互換性維持
3. **Phase 3: メジャーアップデート** - ライブラリ単位で順次
4. **Phase 4: ライブラリ置換** - 最後に実施

---

## Step 7: 計画書の作成

サブエージェントの結果を統合し、以下のフォーマットでMDファイルを出力:

```markdown
# EOL対応計画

作成日: {日付}
対象プロジェクト: {プロジェクト名}
パッケージマネージャー: {npm/yarn/pnpm/bun}

## 概要

| 項目 | 内容 |
|------|------|
| 対象ライブラリ数 | X件 |
| セキュリティ脆弱性 | X件 |
| リスクレベル | {低/中/高} |
| 推奨戦略 | {一括/段階的} |

## セキュリティ監査結果

| パッケージ | 脆弱性レベル | 説明 | 修正バージョン |
|-----------|------------|------|--------------|

## ライブラリグループ

| グループ | メインライブラリ | 関連ライブラリ | 一括アップグレード |
|---------|----------------|---------------|------------------|

## 削除対象パッケージ

| パッケージ | 理由 | 削除タイミング |
|-----------|------|--------------|

## アップグレード戦略

### 推奨アプローチ: {一括/段階的}

{選択理由}

## 段階的アップグレード計画

### Phase 1: {フェーズ名}

**対象**:
- {ライブラリ}: {現在} → {目標}

**破壊的変更への対応**:
| 変更内容 | 影響ファイル | 対応方法 |
|---------|------------|---------|

**アップデートコマンド**:
```bash
{コマンド}
```

**確認項目**:
- [ ] ビルド成功
- [ ] テスト通過
- [ ] 動作確認

---

### Phase 2: ...

## ライブラリ置換計画

（ライブラリ置換が指定された場合のみ）

### {旧ライブラリ} → {新ライブラリ}

#### API対応表
| 旧API | 新API | 備考 |
|-------|-------|------|

#### 移行手順
1. [ ] 新ライブラリをインストール
2. [ ] コード修正
3. [ ] テスト更新
4. [ ] 旧ライブラリを削除

## テスト追加が必要な箇所

| ファイル | 不足テスト |
|---------|----------|

## リスクと対策

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|-------|------|

## ロールバック計画

各フェーズでの問題発生時:
1. {手順}

## 参考リンク

- [マイグレーションガイド]({URL})
- [リリースノート]({URL})
```

---

## 注意事項

- **情報収集はこのコマンド内で完結**: サブエージェントにはプロジェクト情報を渡す
- **サブエージェントはグループ単位で呼び出し**: 個別ライブラリごとに呼び出さない
- **並列呼び出しを活用**: 依存関係がないグループは並列で調査
- **破壊的変更が多い場合は必ず段階的アップグレード**
- **各フェーズで動作確認を行う**
